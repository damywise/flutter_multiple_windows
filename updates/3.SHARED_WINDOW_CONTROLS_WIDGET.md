# Shared Window Controls Widget Implementation

## Overview

This document describes the implementation of a shared widget system for window manipulation controls in the Flutter multi-window application. The system provides reusable components for title bar, frameless, and transparency controls that can be used across different windows with consistent behavior and styling.

## Problem Statement

The original implementation had duplicated window control logic across multiple files:
- `main_window.dart` - Had 3 separate button implementations (90+ lines)
- `regular_window_content.dart` - Had 1 title bar button (30+ lines)
- **Issues**:
  - Code duplication
  - Inconsistent behavior
  - Difficult maintenance
  - Layout problems in constrained spaces

## Solution

Created a shared widget system with three specialized variants for different use cases:

### 1. `WindowControlsWidget` - Full-Featured Version

**File**: `lib/app/window_controls_widget.dart` (lines 16-161)

**Features**:
- Complete window controls with descriptive labels
- "Window Controls" header
- Full error handling and user feedback
- Designed for main window with plenty of space

**Usage**:
```dart
const WindowControlsWidget()
```

**Layout Properties**:
- `crossAxisAlignment: CrossAxisAlignment.stretch` - Buttons expand to full width
- `mainAxisSize: MainAxisSize.min` - Takes only needed vertical space
- `showLabels: true` - Shows descriptive header

### 2. `CompactWindowControlsWidget` - Space-Efficient Version

**File**: `lib/app/window_controls_widget.dart` (lines 163-276)

**Features**:
- Compact buttons without labels
- Condensed error messages
- Designed for regular windows with limited space

**Usage**:
```dart
const CompactWindowControlsWidget()
```

**Layout Properties**:
- `crossAxisAlignment: CrossAxisAlignment.center` - Buttons centered
- `mainAxisSize: MainAxisSize.min` - Minimal vertical space
- Fixed spacing between buttons

### 3. `ConstrainedWindowControlsWidget` - Fixed-Width Version

**File**: `lib/app/window_controls_widget.dart` (lines 278-399)

**Features**:
- Fixed-width buttons (200px) to prevent layout issues
- Guaranteed to work in any constrained layout
- Designed for sub-windows with tight space constraints

**Usage**:
```dart
const ConstrainedWindowControlsWidget()
```

**Layout Properties**:
- `SizedBox(width: 200)` - Each button has fixed width
- `CrossAxisAlignment.center` - Centered alignment
- `MainAxisSize.min` - Minimal vertical space

## Implementation Details

### Widget Structure

All three widgets follow the same pattern:

```dart
class WindowControlsWidget extends StatelessWidget {
  const WindowControlsWidget({
    super.key,
    this.showLabels = true,
    this.spacing = 8.0,
    this.buttonStyle,
  });

  final bool showLabels;
  final double spacing;
  final ButtonStyle? buttonStyle;

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.center, // or stretch
      mainAxisSize: MainAxisSize.min,
      children: [
        // Title Bar Button
        // Frameless Button  
        // Transparency Button
      ],
    );
  }
}
```

### Button Implementation

Each button follows the same pattern:

1. **Get focused window handle**
2. **Validate window exists**
3. **Set up window interception**
4. **Execute window operation**
5. **Show success/failure feedback**

```dart
OutlinedButton(
  onPressed: () async {
    final focusedHwnd = await WindowService.getFocusedFlutterWindowHandle();
    if (focusedHwnd == null) {
      // Show error message
      return;
    }

    final interceptionSuccess = await WindowService.setupWindowInterception(focusedHwnd);
    if (!interceptionSuccess) {
      // Show error message
      return;
    }

    final success = await WindowService.toggleTitleBar(focusedHwnd);
    // Show success/failure message
  },
  child: const Text('Title Bar'),
)
```

## Integration

### Main Window Integration

**File**: `lib/app/main_window.dart`

**Before**:
```dart
// 90+ lines of duplicated button implementations
OutlinedButton(onPressed: () async { /* title bar logic */ }),
OutlinedButton(onPressed: () async { /* frameless logic */ }),
OutlinedButton(onPressed: () async { /* transparency logic */ }),
```

**After**:
```dart
const WindowControlsWidget()
```

**Benefits**:
- Reduced from 90+ lines to 1 line
- Consistent behavior across all controls
- Easy to maintain and modify

### Regular Window Integration

**File**: `lib/app/regular_window_content.dart`

**Before**:
```dart
// 30+ lines of title bar button only
OutlinedButton(onPressed: () async { /* title bar logic */ }),
```

**After**:
```dart
const ConstrainedWindowControlsWidget()
```

**Benefits**:
- Now has all 3 window controls instead of just 1
- Fixed layout issues in constrained spaces
- Consistent with main window behavior

## Layout Fixes

### Problem: Infinite Width Constraints

**Issue**: `CompactWindowControlsWidget` was causing layout errors in sub-windows due to infinite width constraints.

**Error Messages**:
```
BoxConstraints forces an infinite width.
RenderBox was not laid out: RenderFlex
Cannot hit test a render box that has never been laid out.
```

**Solution**: 
- Changed `CrossAxisAlignment.stretch` â†’ `CrossAxisAlignment.center`
- Added `MainAxisSize.min` to prevent infinite expansion
- Created `ConstrainedWindowControlsWidget` with fixed-width buttons

### Layout Properties Comparison

| Widget | Cross Axis | Main Axis | Width | Use Case |
|--------|------------|-----------|-------|----------|
| `WindowControlsWidget` | stretch | min | flexible | Main window |
| `CompactWindowControlsWidget` | center | min | flexible | Regular windows |
| `ConstrainedWindowControlsWidget` | center | min | 200px fixed | Sub-windows |

## Benefits

### 1. Code Reusability
- Single source of truth for window control logic
- Consistent behavior across all windows
- Easy to add new controls in one place

### 2. Maintainability
- Changes to window control logic only need to be made once
- Reduced code duplication by ~120 lines
- Cleaner, more readable main files

### 3. Flexibility
- Three variants for different space constraints
- Customizable styling and spacing
- Easy to extend with new controls

### 4. User Experience
- Consistent UI across all windows
- Same error handling and feedback everywhere
- Professional, polished appearance

### 5. Layout Stability
- Fixed layout issues in constrained spaces
- Proper hit testing and rendering
- No more infinite width constraint errors

## Usage Examples

### Basic Usage

```dart
// Main window - full controls with labels
const WindowControlsWidget()

// Regular window - compact controls
const CompactWindowControlsWidget()

// Sub-window - constrained controls
const ConstrainedWindowControlsWidget()
```

### Custom Styling

```dart
WindowControlsWidget(
  showLabels: false,
  spacing: 12.0,
  buttonStyle: OutlinedButton.styleFrom(
    padding: EdgeInsets.all(16),
  ),
)
```

### Custom Spacing

```dart
CompactWindowControlsWidget(
  spacing: 8.0,
)
```

## Future Enhancements

### Planned Features
- **Toggle States**: Show current state of each control (title bar hidden/visible, etc.)
- **Icon Support**: Add icons to buttons for better visual recognition
- **Animation**: Smooth transitions between states
- **Keyboard Shortcuts**: Support for keyboard shortcuts
- **State Persistence**: Remember window states across sessions

### Extensibility
- **New Controls**: Easy to add new window manipulation features
- **Custom Variants**: Create specialized variants for specific use cases
- **Theme Integration**: Better integration with Flutter theming system

## Related Files

- `lib/app/window_controls_widget.dart` - Main implementation
- `lib/app/main_window.dart` - Main window integration
- `lib/app/regular_window_content.dart` - Regular window integration
- `lib/app/window_service.dart` - Service layer for window operations

## Dependencies

- `package:flutter/material.dart` - Flutter Material Design
- `window_service.dart` - Window manipulation service
- Native C++ implementation - Actual window operations

## Testing

### Manual Testing
1. **Main Window**: Verify all controls work and show proper feedback
2. **Regular Windows**: Verify controls work in constrained layout
3. **Sub-windows**: Verify fixed-width controls prevent layout issues
4. **Error Handling**: Test with no focused window, invalid handles, etc.

### Layout Testing
1. **Different Screen Sizes**: Test on various window sizes
2. **Constrained Layouts**: Test in tight spaces
3. **Responsive Design**: Verify controls adapt properly

## Troubleshooting

### Common Issues

1. **Layout Errors in Sub-windows**
   - **Solution**: Use `ConstrainedWindowControlsWidget` instead of `CompactWindowControlsWidget`

2. **Buttons Not Showing**
   - **Check**: Ensure proper import of `window_controls_widget.dart`
   - **Check**: Verify widget is properly placed in widget tree

3. **Inconsistent Styling**
   - **Solution**: Use `buttonStyle` parameter for custom styling
   - **Solution**: Ensure consistent theme across all windows

### Debug Information

The widgets provide detailed console logging for debugging:
```
Window subclassing set up for hwnd: 0x0000000006B10F24
Window background set to transparent for hwnd: 0x0000000006B10F24
Title bar toggled for 0x6B10F24
```

## Conclusion

The shared window controls widget system successfully addresses the original problems of code duplication and layout issues while providing a flexible, maintainable solution for window manipulation controls across the Flutter multi-window application. The three specialized variants ensure optimal user experience in different contexts while maintaining consistent behavior and functionality.
