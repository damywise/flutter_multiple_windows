# Transparent Background Implementation

## Overview

This document describes the implementation of transparent window backgrounds for Flutter multi-window applications on Windows. The implementation allows Flutter windows to have fully transparent backgrounds, enabling see-through effects to the desktop or other windows behind them.

## Features

- **Full Window Transparency**: Makes window backgrounds completely transparent
- **Independent Operation**: Works independently of title bar and frameless states
- **State Preservation**: Maintains transparency through window state changes
- **Method Channel Integration**: Accessible from Dart via method channels

## Implementation Details

### Native C++ Implementation

#### Windows API Structures

The implementation uses Windows composition attributes to achieve transparency:

```cpp
typedef enum _WINDOWCOMPOSITIONATTRIB {
  WCA_ACCENT_POLICY = 19,
  // ... other attributes
} WINDOWCOMPOSITIONATTRIB;

typedef enum _ACCENT_STATE {
  ACCENT_DISABLED = 0,
  ACCENT_ENABLE_TRANSPARENTGRADIENT = 2,
  // ... other states
} ACCENT_STATE;

typedef struct _ACCENT_POLICY {
  ACCENT_STATE AccentState;
  DWORD AccentFlags;
  DWORD GradientColor;
  DWORD AnimationId;
} ACCENT_POLICY;
```

#### Method Channel Handler

**Method Name**: `setTransparentBackground`

**Parameters**:
- `hwnd` (int64): Window handle
- `transparent` (bool): True for transparent, false for normal

**Implementation Location**: `windows/runner/main.cpp` lines 1218-1323

#### State Management

The implementation tracks transparency state globally:

```cpp
// Global state to track Flutter windows with transparent backgrounds
std::map<HWND, bool> g_flutter_transparent_windows;
```

### Dart Integration

#### Service Layer

**File**: `lib/app/window_service.dart`

```dart
/// Sets the window background to be transparent or normal.
/// transparent: true for transparent background, false for normal background.
static Future<bool> setTransparentBackground(int hwnd, {required bool transparent}) async {
  try {
    final bool? success = await _channel.invokeMethod('setTransparentBackground', {
      'hwnd': hwnd,
      'transparent': transparent,
    });
    return success ?? false;
  } on PlatformException catch (e) {
    print('Failed to set transparent background: ${e.message}');
    return false;
  }
}
```

#### UI Integration

**File**: `lib/app/main_window.dart`

The UI provides a button to test transparency:

```dart
OutlinedButton(
  onPressed: () async {
    final focusedHwnd = await WindowService.getFocusedFlutterWindowHandle();
    if (focusedHwnd != null) {
      final success = await WindowService.setTransparentBackground(focusedHwnd, transparent: true);
      // Show success/failure feedback
    }
  },
  child: const Text('Set Transparent Background'),
)
```

## Technical Implementation

### DWM Frame Extension

Transparency requires extending the DWM frame into the client area:

```cpp
// Use frameless-style margins for transparency compatibility
MARGINS margins = {0, 0, 1, 0};  // 1px top margin extends DWM into title bar area
::DwmExtendFrameIntoClientArea(hwnd, &margins);
```

### Accent Policy Application

The transparency effect is achieved using Windows accent policies:

```cpp
ACCENT_POLICY accent = {
    ACCENT_ENABLE_TRANSPARENTGRADIENT,  // AccentState
    2,                                  // AccentFlags
    0x00000000,                         // GradientColor (fully transparent in ABGR format)
    0                                   // AnimationId
};

WINDOWCOMPOSITIONATTRIBDATA data;
data.Attrib = WCA_ACCENT_POLICY;
data.pvData = &accent;
data.cbData = sizeof(accent);

g_set_window_composition_attribute(hwnd, &data);
```

### State-Aware Logic

The implementation includes intelligent state management:

1. **State Check**: Verifies if transparency is already in the desired state
2. **Conditional Application**: Only applies changes when transitioning states
3. **State Preservation**: Maintains transparency through other window operations

```cpp
// Check if transparency is already in the desired state
auto transparentIt = g_flutter_transparent_windows.find(hwnd);
bool currentlyTransparent = (transparentIt != g_flutter_transparent_windows.end() && transparentIt->second);

if (transparent == currentlyTransparent) {
  // Already in desired state, no need to do anything
  return;
}
```

## Integration with Other Features

### Title Bar Operations

When title bar visibility is changed, transparency is automatically reapplied:

```cpp
// If transparency was active before, reapply it after title bar change
if (wasTransparent && g_set_window_composition_attribute) {
  // Reapply transparency accent policy
}
```

### Frameless Operations

Frameless mode changes also preserve transparency:

```cpp
// If transparency was active before, reapply it after frameless change
if (wasTransparent && g_set_window_composition_attribute) {
  // Reapply transparency accent policy
}
```

## Usage Examples

### Basic Transparency

```dart
// Get the focused window
final hwnd = await WindowService.getFocusedFlutterWindowHandle();

// Set transparent background
await WindowService.setTransparentBackground(hwnd!, transparent: true);

// Restore normal background
await WindowService.setTransparentBackground(hwnd!, transparent: false);
```

### With Window State Changes

```dart
// Set transparency
await WindowService.setTransparentBackground(hwnd!, transparent: true);

// Toggle title bar (transparency will be preserved)
await WindowService.toggleTitleBar(hwnd!);

// Toggle frameless (transparency will be preserved)
await WindowService.toggleFrameless(hwnd!);
```

## Troubleshooting

### Common Issues

1. **Transparency not working on first press**
   - Ensure `SetWindowCompositionAttribute` is loaded successfully
   - Check console output for error messages

2. **Transparency breaks after other operations**
   - This should be fixed in the current implementation
   - Transparency is automatically reapplied after state changes

3. **Performance issues**
   - Transparency uses DWM composition which may impact performance
   - Consider disabling transparency for better performance if needed

### Debug Information

The implementation provides detailed console logging:

```
SetWindowCompositionAttribute loaded successfully
Window background set to transparent for hwnd: 0x12345678
Reapplied transparency after title bar change for hwnd: 0x12345678
```

## Dependencies

- **Windows 10/11**: Required for DWM composition features
- **user32.dll**: For `SetWindowCompositionAttribute` function
- **dwmapi.lib**: For DWM frame extension functions

## Limitations

- **Windows Only**: This implementation is specific to Windows
- **DWM Dependency**: Requires Desktop Window Manager to be enabled
- **Performance Impact**: May have slight performance impact due to composition

## Future Enhancements

- **Partial Transparency**: Support for semi-transparent backgrounds
- **Color Tinting**: Support for colored transparency effects
- **Animation Support**: Smooth transitions between transparent and opaque states
- **Multi-Monitor Support**: Enhanced support for different DPI scaling

## Related Files

- `windows/runner/main.cpp` - Native implementation
- `lib/app/window_service.dart` - Dart service layer
- `lib/app/main_window.dart` - UI integration
- `flutter_acrylic_plugin.cpp` - Reference implementation

## References

- [Windows Composition API Documentation](https://docs.microsoft.com/en-us/windows/win32/dwm/composition-ovw)
- [SetWindowCompositionAttribute Function](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowcompositionattribute)
- [DwmExtendFrameIntoClientArea Function](https://docs.microsoft.com/en-us/windows/win32/api/dwmapi/nf-dwmapi-dwmextendframeintoclientarea)
